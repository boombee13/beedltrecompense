<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #fcfaf8; 
            --table-bg: #ffffff;
            --header-bg: #ffd6c9; 
            --header-text: #5e5c5c;
            --row-hover: #fff3ed; 
            --text-main: #6b6b6b;
            --btn-map: #b5ead7; 
            --btn-map-hover: #9bd6c2;
            --btn-action: #ffbba6;
            --btn-action-hover: #ffa48a;
            --link-color: #a2add0; 
            --tab-bg: #f1f1f1;
            --tab-active: #ffbba6; 
        }
        
        body { font-family: 'Sarabun', sans-serif; padding: 30px 15px; background-color: var(--bg-color); color: var(--text-main); margin: 0; font-size: 15px; }
        h2 { text-align: center; color: #7b7b7b; margin-bottom: 20px; font-weight: 600; }
        
        .tabs-container { display: flex; justify-content: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { font-family: 'Sarabun', sans-serif; padding: 10px 24px; border: none; background-color: var(--tab-bg); color: var(--text-main); border-radius: 25px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .tab-btn:hover { background-color: #e2e2e2; }
        .tab-btn.active { background-color: var(--tab-active); color: white; box-shadow: 0 4px 10px rgba(255, 187, 166, 0.4); }

        .table-container { border-radius: 16px; overflow-x: auto; -webkit-overflow-scrolling: touch; box-shadow: 0 8px 24px rgba(0,0,0,0.04); background: var(--table-bg); max-width: 1100px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 16px 20px; text-align: left; border-bottom: 1px solid #f4f4f4; white-space: nowrap; }
        th { background-color: var(--header-bg); color: var(--header-text); font-weight: 600; font-size: 16px; }
        tr:hover td { background-color: var(--row-hover); }

        a.link-text { color: var(--link-color); text-decoration: none; font-weight: 600; }
        a.link-text:hover { text-decoration: underline; }

        a.btn { display: inline-block; padding: 8px 18px; background: var(--btn-map); color: #5a7065; text-decoration: none; border-radius: 20px; font-size: 14px; font-weight: 600; transition: all 0.3s ease; }
        a.btn:hover { background: var(--btn-map-hover); transform: translateY(-1px); }

        button.btn-action { font-family: 'Sarabun', sans-serif; padding: 8px 18px; background: var(--btn-action); color: white; border: none; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        button.btn-action:hover { background: var(--btn-action-hover); transform: translateY(-1px); }
        button.btn-action:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .status-badge { background-color: #f1f1f1; padding: 6px 12px; border-radius: 12px; font-size: 14px; color: #777; }
        
        /* ‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏ö‡πÜ ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô */
        #loadingIndicator { position: fixed; top: 15px; right: 20px; font-size: 13px; color: #aaa; display: none; }
    </style>
</head>
<body>

    <div id="loadingIndicator">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...</div>
    <h2>‚ú® ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>
    
    <div class="tabs-container">
        <button class="tab-btn" onclick="filterData('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</button>
        <button class="tab-btn active" onclick="filterData('‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', this)">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</button>
        <button class="tab-btn" onclick="filterData('Moved', this)">‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß (Moved)</button>
    </div>
    
    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Link</th>
                    <th>Road</th>
                    <th>Sub District</th>
                    <th>District</th>
                    <th>Province</th>
                    <th>Location</th>
                    <th>Status</th>
                    <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="10" style="text-align:center; padding: 30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // üö® ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÅ‡∏Å‡πâ API URL ‡∏ó‡∏±‡πâ‡∏á 2 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        const API_URL = 'YOUR_GAS_API_URL'; 
        const N8N_WEBHOOK_URL = 'YOUR_N8N_WEBHOOK_URL';

        let allData = []; 
        let currentFilter = '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Default Tab
        let processingRows = []; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (isAutoRefresh = true ‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
        async function fetchData(isAutoRefresh = false) {
            if (isAutoRefresh) {
                document.getElementById('loadingIndicator').style.display = 'block';
            }

            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                const getValue = (row, keyName) => {
                    const actualKey = Object.keys(row).find(k => k.trim() === keyName);
                    return actualKey ? row[actualKey] : '';
                };

                allData = data.filter(row => {
                    const dateVal = getValue(row, 'Date');
                    const linkVal = getValue(row, 'Link');
                    return (dateVal !== '' && dateVal !== undefined) || (linkVal !== '' && linkVal !== undefined);
                }).map(row => {
                    return {
                        rowNumber: row['rowNumber'],
                        date: getValue(row, 'Date'),
                        time: getValue(row, 'Time'),
                        link: getValue(row, 'Link'),
                        road: getValue(row, 'Road'),
                        subDistrict: getValue(row, 'Sub District'),
                        district: getValue(row, 'District'),
                        province: getValue(row, 'Province'),
                        location: getValue(row, 'Location'),
                        status: getValue(row, 'Status') || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'
                    };
                });

                applyCurrentFilter(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏° Tab ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            } catch (error) {
                console.error("Fetch Error:", error);
            } finally {
                if (isAutoRefresh) {
                    setTimeout(() => document.getElementById('loadingIndicator').style.display = 'none', 1000);
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function renderTable(dataToRender) {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = ''; 

            if (dataToRender.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding: 40px; color: #aaa;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${currentFilter}</td></tr>`;
                 return;
            }

            dataToRender.forEach(row => {
                const tr = document.createElement('tr');
                const linkImg = row.link ? `<a href="${row.link}" class="link-text" target="_blank">‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a>` : '-';
                const linkMap = row.location ? `<a href="${row.location}" class="btn" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Google Maps</a>` : '-';
                
                // ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°
                const isMoved = (row.status.toLowerCase() === 'moved' || row.status === '‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || row.status === 'reported');
                const isProcessing = processingRows.includes(row.rowNumber.toString());

                let actionBtn = '';
                if (isMoved) {
                    actionBtn = `<span style="color: #aaa; font-size: 13px;">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>`;
                    // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Sheet
                    if (isProcessing) {
                        processingRows = processingRows.filter(r => r !== row.rowNumber.toString());
                    }
                } else if (isProcessing) {
                    actionBtn = `<span style="color: #f39c12; font-size: 13px; font-weight: 600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>`;
                } else {
                    actionBtn = `<button class="btn-action" onclick="triggerMove('${row.rowNumber}', this)">‡∏™‡∏±‡πà‡∏á‡∏¢‡πâ‡∏≤‡∏¢</button>`;
                }

                tr.innerHTML = `
                    <td>${row.date || '-'}</td>
                    <td>${row.time || '-'}</td>
                    <td>${linkImg}</td>
                    <td>${row.road || '-'}</td>
                    <td>${row.subDistrict || '-'}</td>
                    <td>${row.district || '-'}</td>
                    <td>${row.province || '-'}</td>
                    <td>${linkMap}</td>
                    <td><span class="status-badge status-text">${row.status}</span></td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Tab
        function applyCurrentFilter() {
            if (currentFilter === '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') {
                renderTable(allData);
            } else {
                // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ Moved ‡πÅ‡∏•‡∏∞ ‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                const filteredData = allData.filter(row => {
                    if (currentFilter === 'Moved') {
                        return row.status.toLowerCase() === 'moved' || row.status === '‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß' || row.status === 'reported';
                    }
                    return row.status === currentFilter;
                });
                renderTable(filteredData);
            }
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Tab
        function filterData(statusFilter, btnElement) {
            currentFilter = statusFilter;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
            applyCurrentFilter();
        }

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏™‡∏±‡πà‡∏á‡∏¢‡πâ‡∏≤‡∏¢
        async function triggerMove(rowNumber, btnElement) {
            processingRows.push(rowNumber.toString()); // ‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ
            btnElement.outerHTML = `<span style="color: #f39c12; font-size: 13px; font-weight: 600;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏±‡πà‡∏á...</span>`;

            try {
                await fetch(`${N8N_WEBHOOK_URL}?row=${rowNumber}`, { mode: 'no-cors' });
            } catch (error) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏á‡∏≤‡∏ô n8n");
                processingRows = processingRows.filter(r => r !== rowNumber.toString()); // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error
                fetchData(true);
            }
        }

        // ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
        fetchData();

        // üö® ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (Auto-Refresh) ‡∏ó‡∏∏‡∏Å‡πÜ 12 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        setInterval(() => {
            fetchData(true);
        }, 12000);

    </script>
</body>
</html>
